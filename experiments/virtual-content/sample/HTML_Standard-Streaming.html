<!DOCTYPE html>
<style>
virtual-content:not([ready]) {
  display: none;
}
</style>
<script type="module">
import {VirtualContent} from '../virtual-content.js';

const vc = new VirtualContent();
document.body.appendChild(vc);

const doc = document.implementation.createHTMLDocument();
doc.open();

const mo = new MutationObserver(entries => {
  const bodyFragment = new DocumentFragment();

  for (const entry of entries) {
    for (const node of entry.addedNodes) {
      if (node.parentNode === doc.head) {
        document.head.appendChild(node);
      } else if (node.parentNode === doc.body) {
        bodyFragment.appendChild(node);
      }

      if (node === doc.body) {
        mo.disconnect();
        mo.observe(doc.body, {childList: true});
      }
    }
  }

  vc.appendChild(bodyFragment);
});
mo.observe(doc, {childList: true, subtree: true});


(async () => {
  console.log('Starting fetch...');
  const response = await fetch('https://html.spec.whatwg.org');

  console.log('Getting response reader...');
  const reader = await response.body.getReader();
  const decoder = new TextDecoder('utf-8');

  console.log('Streaming...');
  let syncStart = 0;
  while (true) {
    if (performance.now() - syncStart > 0.5 * (1000 / 60)) {
      await new Promise(resolve =>
          window.requestIdleCallback(resolve, {timeout: 10 * (1000 / 60)}));
      syncStart = performance.now();
    }

    const {done, value} = await reader.read();
    if (done) {
      decoder.decode();
      break;
    }

    console.log(`Decoding ${value.length} bytes...`);
    doc.write(decoder.decode(value, {stream: true}));
  }

  console.log('Done.');
})();
</script>
